/*!CK:3413752080!*//*1456170532,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["0ZyPg"]); }

__d('MessengerVoiceClipFlyout.react',['Event','FBRTCConstants','FBRTCStreamWrapper','FBRTCUserMedia','Keys','Link.react','MessengerRecorder','ReactComponentWithPureRenderMixin','React','ReactDOM','cancelAnimationFrame','requestAnimationFrame','SubscriptionsHandler','cx','fbt','sumOfArray'],function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w){'use strict';if(c.__markCompiled)c.__markCompiled();var x=p.PropTypes,y=300,z=72;function aa(ca){if(!ca||!ca.getByteFrequencyData)return 0;var da=new Uint8Array(2048);ca.getByteFrequencyData(da);var ea=w(da)/2048,fa=ea>100?1:ea/100,ga=(y-z)*fa+z;return ga;}var ba=p.createClass({displayName:'VoiceClipFlyout',_recorder:undefined,_animation:undefined,_analyser:undefined,_subscriptionsHandler:new t(),mixins:[o],propTypes:{onShown:x.func,onHidden:x.func,onEscKeyDown:x.func,shown:x.bool,threadID:x.string,viewer:x.string},getDefaultProps:function(){return {shown:false};},getInitialState:function(){return {animationWidth:null,intervalID:null,recording:false,recordingIntervalID:null,recordingTime:0};},componentDidMount:function(){this._subscriptionsHandler.addSubscriptions(h.listen(q.findDOMNode(this),'keydown',this._onKeyDown));if(this.props.shown)this._onShown();},componentWillUnmount:function(){this._subscriptionsHandler.release();},componentDidUpdate:function(ca){if(!ca.shown&&this.props.shown){this._onShown();}else if(ca.shown&&!this.props.shown)this._onHidden();},render:function(){return (p.createElement('div',{'aria-label':v._("Voice Clip"),className:"_3z51"+(this.state.recording?' '+"_3z52":''),role:'dialog'},this._renderRecordButton(),p.createElement('div',{className:"_3z53"},this._formatTime()),this._renderCancelButton()));},_onShown:function(){},_onHidden:function(){r(this._animation);this._recorder&&this._recorder.stop();this._recorder&&this._recorder.clear();window.clearInterval(this.state.recordingIntervalID);k.end();k.removeAllListeners();this.setState(this.getInitialState());},_onKeyDown:function(event){if(event.keyCode===l.ESC&&this.props.onEscKeyDown){this.props.onEscKeyDown();event.kill();}},_formatTime:function(){var ca=Math.floor(this.state.recordingTime/60),da=this.state.recordingTime%60;if(da<10)da='0'+da;return ca+':'+da;},_renderRecordButton:function(){var ca=null;if(!this.state.recording)ca=v._("Record");return (p.createElement('div',null,p.createElement('div',{className:"_3z54",style:{height:this.state.animationWidth,width:this.state.animationWidth}}),p.createElement(m,{onClick:this._toggleRecording},p.createElement('div',{className:"_3z55"},p.createElement('span',{className:"_3z56"},ca)))));},_renderCancelButton:function(){if(this.state.recording)return (p.createElement(m,{className:"_3z58",onClick:this.props.onHidden},v._("Cancel")));return null;},_initializeRecorder:function(ca){k.addListener('streamReady',function(da){this._onSuccess(da,ca);}.bind(this));k.addListener('accessDenied',function(){});k.addListener('accessFailed',function(){});k.requestUserMedia(i.StreamType.AUDIO_ONLY,i.VideoQuality.NO_VIDEO);},_onSuccess:function(ca,da){this._recorder=new n(ca);var ea=new j();ea.setStream(ca);this._analyser=ea.getAudioAnalyser();da();},_animate:function(ca){this._animation=s(function(){this.setState({animationWidth:aa(ca)});this._animate(ca);}.bind(this));},_record:function(){this._recorder&&this._recorder.record();var ca=window.setInterval(function(){this.setState({recordingTime:this.state.recordingTime+1});}.bind(this),1000);this._animate(this._analyser);this.setState({recording:true,recordingTime:0,recordingIntervalID:ca});},_toggleRecording:function(){if(!this.state.recording){this._initializeRecorder(this._record);}else{this._recorder&&this._recorder.stop();this._recorder&&this._recorder.exportWAV(this.props.onVoiceClipCreate);this._recorder&&this._recorder.clear();this.props.onHidden&&this.props.onHidden();}}});f.exports=ba;},null);